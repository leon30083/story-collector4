# AI对话上下文日志

## 项目简介
儿童绘本故事收集系统，旨在高效收集、整理、管理适合儿童绘本的故事题材，支持批量导入、AI采集、查重、分类、编辑、导出等。前端采用React+MUI，后端采用Flask+SQLAlchemy，数据库为SQLite，AI内容生成通过硅基流动API，结合动态Prompt模板。

---

## 当前开发阶段
- 主要目标/任务：
  - 支持故事采集、批量上传、查重、分类管理、故事展示与筛选、编辑与删除、导出、统计与可视化。
  - 采集逻辑强调"强制数量、去重、多样性"，支持长篇拆分、地方版本、细节变化。
- 近期已完成的关键进展：
  - 前后端项目结构与依赖配置
  - 故事CSV上传、查重、批量导入
  - 故事列表展示、筛选、搜索、详情弹窗
  - 故事编辑、删除、采集、API集成
  - 设置持久化、参数配置、界面优化
  - Prompt管理与AI协作日志机制完善
- 当前卡点/待解决问题：
  - 高级功能开发（分页、批量操作、导出、统计、UI美化、权限等）

---

## 重要决策与历史背景
- 目录结构、Prompt与AI协作日志已标准化，便于长期维护
- 查重、去重、API调用、Prompt路径等关键问题已优化解决
- 采集Prompt已高度优化，强调数量、去重、多样性、格式规范
- 采集与整理思路：长篇/合集类作品可拆分为多个独立故事，优先选择情节紧凑、角色鲜明、寓意积极的小故事或片段

---

## 需求与待办事项
- [ ] 支持分页与排序，提升大数据量下的浏览体验
- [ ] 故事导出功能（CSV/Excel）
- [ ] 故事批量删除、批量编辑
- [ ] 分类统计与可视化
- [ ] UI美化与响应式优化
- [ ] 用户权限与登录（如有需求）
- [ ] 采集表单支持更多自定义选项（如故事长度、风格等）
- [ ] 支持批量采集（如一次生成多条故事）
- [ ] 采集历史可追溯，支持重试、编辑采集结果
- [ ] 采集结果可直接导出或分享
- [ ] 故事内容敏感词过滤或审核提示
- [ ] 用户可对采集结果进行评分或反馈

---

## AI协作建议
- 希望AI协助代码实现、架构建议、Bug排查、文档撰写、测试用例设计、Prompt优化等
- 需注意历史决策、风格、兼容性、日志同步等
- 重要进展、决策、问题建议及时补充到本文件，保持团队与AI协作上下文同步

---

## 系统架构与代码地图
- 前端：React + MUI，负责交互、数据展示、采集请求、日志与进度反馈
- 后端：Flask + SQLAlchemy，API服务、AI采集、数据库管理、查重、分类管理
- 数据库：SQLite，存储故事与分类
- AI内容生成：硅基流动API，结合动态Prompt模板，自动采集和生成故事

### 主要功能模块
- 故事采集（AI+人工）、批量上传、查重、分类管理、故事展示与筛选、编辑与删除、导出、统计与可视化
- 支持多模型、多参数、采集日志、进度提示、错误反馈

### 目录结构
详见《系统架构与代码地图.md》

---

## 采集与整理思路
- 长篇/合集类作品（如《西游记》《格林童话集》）可拆分为多个独立故事
- 每个故事需情节完整、适合8-12页绘本、语言简洁、积极向上
- 优先选择情节紧凑、角色鲜明、寓意积极的小故事或片段
- 分类管理细致，便于检索和后续使用

---

## 采集Prompt模板（核心指令摘要）
- 强制采集指定数量（N）个指定分类（category）的故事，必须去重，优先补足数量
- 仅排除与数据库已有故事"标题完全相同"或"核心情节完全一致"的故事
- 返回格式为JSON数组，每个故事包含title、category、summary（含出处）
- summary内容简洁明了，适合表格展示
- 只输出JSON数组，不输出任何解释或多余内容
- 鼓励采集同一神话/人物/事件的不同版本、地方讲法、细节变化
- 详见《optimized_story_collect_prompt.md》

---

## 测试用例与质量保障
- 功能测试：采集、查重、上传、编辑、删除、导出、批量操作、进度日志、历史追溯等
- 参数与模型测试：AI模型切换、参数调整、API Key配置等
- 查重与一致性：重复检测、数据库与前端一致性
- 交互与体验：进度提示、错误反馈、表单校验、详情查看
- 边界与异常：超长输入、空内容、重复提交、接口超时、API限流等
- 扩展性与安全：自定义选项、批量采集、内容安全、用户反馈
- 详见《收集功能测试用例清单.md》

---

## 重要对话片段（AI历史问答精华）
- 2024-06-08：
  - 梳理并优化了AI协作上下文日志和Prompt的管理方式，所有AI协作相关文件（AI对话上下文.md、AI协作工作流使用说明.md、Prompt模板）已统一迁移至ai-collab/目录，并在prompts子目录下集中管理Prompt。
  - Prompt内容已升级，路径全部指向ai-collab/AI对话上下文.md，确保AI每次新会话都能准确加载上下文。
  - 明确了AI协作工作流的维护方法，包括日志维护、会话启动、对话片段整理、AI主动同步建议等。
  - 通过Cursor规则和Prompt，确保AI能主动提醒用户同步更新已解决的历史问题，保持日志与实际进度一致。
  - 目录结构和文件命名已标准化，便于长期维护和团队协作。
- 2024-06-13：
  - 讨论了将AI辅助绘本文稿创作集成到系统的优先级，决定优先实现结构化创作编辑器，后续再集成AI绘图和AI音乐模块。
  - 分析了现有gpts-prompt、ai_picturebook_styles.json、经典改编.md等知识库文件，确认已具备高质量AI文本创作能力和风格推荐机制。
  - 明确下一步以"结构化、可视化、可交互的绘本文稿创作平台"为目标，建议实现分段/分页编辑、风格模板一键应用、经典改编流程集成、AI辅助与手动编辑结合、作品管理与导出、为后续插图/音乐生成预留接口。
  - 推荐前端采用富文本/结构化编辑器，后端扩展API支持作品结构化存储与AI接口调用。
  - 建议优先梳理创作编辑器页面结构、数据结构、前端AI集成方式、作品管理与导出功能。
  - 明确如需UI原型、数据结构、API设计等具体方案，可随时让AI协助细化。

---

## 其他备注
- 任何你觉得AI需要知道的内容。

# 开发日志

## 项目名称：儿童绘本故事收集系统

### 2025-05-24

#### 1. 项目初始化
- [x] 初始化前端（React）与后端（Flask）项目结构
- [x] 配置本地开发环境，完成依赖安装
- [x] 初始化Git仓库并推送到GitHub

#### 2. 基础功能开发
- [x] 实现CSV文件上传功能，支持故事批量导入
- [x] 实现故事列表展示，支持按分类筛选
- [x] 前后端数据流转打通，上传后自动刷新列表

### 2025-05-25

#### 3. API集成与内容生成
- [x] 前端：增加"采集/生成故事"入口，支持API Key和偏好设置
- [x] 后端：完善`/api/collect`接口，调用硅基流动API，保存新故事
- [x] 设置组件优化：
  - 添加模型选择功能
  - 添加AI参数设置（温度、最大令牌数、Top P）
  - 实现设置持久化存储
  - 优化界面布局

#### 4. 数据导入与查重
- [x] 后端：上传时查重逻辑，防止重复故事入库
- [x] 前端：上传结果提示查重情况
- [x] 支持中文表头自动映射，兼容常见Excel导出格式

#### 5. 故事管理与展示
- [x] 故事列表重构为表格/列表模式，支持分类筛选、关键词搜索、简介预览、详情弹窗
- [x] 修复简介字段显示问题
- [x] 支持故事编辑、删除操作，含弹窗与全局提示

#### 6. 故事收集功能优化
- [x] 实现基于API的故事收集功能，支持指定数量和分类
- [x] 后端动态构建Prompt，将已有故事标题告知大模型用于去重
- [x] 后端实现本地查重和多次尝试补足逻辑
- [x] 前端增加采集进度显示和日志区域
- [x] 修复API调用400 Bad Request问题（Function call role更正）
- [x] 修复Prompt文件读取路径问题
- [x] 修复同名Prompt文件冲突问题
- [x] 优化Prompt指令，明确去重和分类要求
- [x] 修复AI返回内容不完整导致JSON解析失败的问题（提高API max_tokens限制）

### 2025-05-29

#### 结构化编辑器与AI生成内容集成
- [x] 结构化编辑器支持多页自动编号、分段编辑、插入/删除页、批量分段、导入导出markdown
- [x] StoryCreationForm 支持AI一键生成后，将完整结构化文稿（含pages）通过onConfirm回调传递到App.js
- [x] App.js在onConfirm后自动切换到StoryEditorPage，并将AI生成的story数据作为initParams传递
- [x] StoryEditorPage支持initParams变化时自动刷新story，确保每次新建/AI生成后都能正确显示最新文稿内容
- [x] 侧边结构树支持插入/删除页，主编辑区支持多页内容块编辑，风格推荐与操作日志功能正常
- [x] 批量粘贴/一键分段功能支持按空行自动分段生成多页
- [x] 导入/导出markdown功能支持与专业文稿格式互转
- [x] 前后端联调顺畅，AI生成内容可直接进入结构化编辑器，极大提升了内容生产效率

---

## 下一阶段开发计划

#### 7. 高级功能与体验优化
- [ ] 支持分页与排序，提升大数据量下的浏览体验
- [ ] 故事导出功能（CSV/Excel）
- [ ] 故事批量删除、批量编辑
- [ ] 分类统计与可视化
- [ ] UI美化与响应式优化
- [ ] 用户权限与登录（如有需求）

---

## 当前最高优先级开发计划（2024-5-28）

> 本阶段为全团队最高优先级，所有资源优先保障如下任务：

### 结构化绘本创作平台UI开发第一阶段
1. 实现首页/故事库总览页面（列表、筛选、批量操作、新建入口）
2. 搭建新建/编辑故事结构化编辑器（左侧结构树、主编辑区、风格推荐、AI交互历史）
3. 接入风格模板API，完成风格推荐与应用功能
4. 实现AI一键生成/补全/润色的基础接口与前端调用

> 相关详细方案、文件路径、技术选型等详见下方"结构化绘本创作平台UI开发计划"章节。

---

## 结构化绘本创作平台功能规划（2024-05-28）

### 1. UI原型与交互
- 参考《text/UI原型参考/》文件，采用结构化、分段/分页编辑界面：
  - 顶部导航：返回故事库、新建、保存、导出、AI辅助、经典改编
  - 左侧结构树：故事标题、分页节点（可拖拽排序、增删页）
  - 主编辑区：每页中英文对照、旁白、配图建议、风格选择、AI一键生成/润色
  - 右侧风格推荐：自动匹配年龄+主题，展示风格名、说明、示例，切换风格自动应用模板
  - 底部操作日志/AI交互历史

### 2. 数据结构
- 故事Story结构：
  - id, title, author, age_range, theme, style_id, pages[], classic_adapted, classic_source, summary, created_at, updated_at
  - pages[]: page_no, text_cn, text_en, image_hint, template_used
- 风格Style结构：直接引用ai_picturebook_styles.json

### 3. API设计
- 故事管理：GET/POST/PUT/DELETE /api/story（结构化内容）
- 风格与模板：GET /api/styles
- AI辅助生成：POST /api/ai/generate、/api/ai/recommend_styles、/api/ai/adapt_classic

### 4. 其它规划
- 支持经典改编流程，按手册自动分段生成
- 支持AI一键生成、补全、润色，手动编辑结合
- 作品可保存、导出，预留插图/音乐生成接口
- 后端API主文件：backend/app.py，前端采用React+MUI
- 详细UI、数据结构、API参数可随时细化

---

## 接口文档与代码定位

### 后端API主文件
- 位置：`backend/app.py`
- 技术栈：Flask + SQLAlchemy

### 主要API接口一览

| 路径 | 方法 | 功能说明 |
|------|------|----------|
| /api/upload | POST | 上传CSV文件，批量导入故事，自动查重、分类 |
| /api/stories | GET | 获取故事列表，支持按分类和批次筛选 |
| /api/collect | POST | 采集AI故事，动态构建Prompt，去重、补足数量 |
| /api/settings | POST | 更新API Key等设置 |
| /api/models | POST | 获取可用AI模型列表 |
| /api/story/<id> | PUT | 编辑单个故事 |
| /api/story/<id> | DELETE | 删除单个故事 |
| /api/categories | GET | 获取所有分类 |
| /api/categories | POST | 新增分类 |
| /api/categories/<id> | PUT | 编辑分类（含同步故事表） |
| /api/categories/<id> | DELETE | 删除分类及其下所有故事 |
| /api/stories/batch_delete | POST | 批量删除故事 |
| /api/stories/batch_update_category | POST | 批量修改故事分类 |
| /api/stories/batch_export | POST | 批量导出故事（CSV） |
| /api/stories/export_by_batch | GET | 按批次导出故事（CSV） |

> 详细参数、字段、示例可参考 `backend/app.py` 代码实现。如需自动生成详细接口文档，可进一步提取和补充。

---

## 结构化绘本创作平台UI开发计划（2024-06-XX）

### 1. 相关文件与存放位置
- UI原型图片：`text/UI原型参考/1.png` ~ `6.png`
- UI原型详细解读文档：`text/UI原型参考/UI原型图片详细解读.md`
  - 用途：梳理每个页面的功能区块、交互流程和设计要点，供前端开发、产品设计、团队沟通参考
- 风格模板数据：`text/ai_picturebook_styles.json`
- 经典改编规则与流程：`text/经典改编.md`

### 2. UI开发详细方案

#### 2.1 技术选型
- 前端：React + MUI（Material UI），支持响应式、组件化开发
- 状态管理：Redux或Context API
- 富文本/结构化编辑：Draft.js、Slate.js或MUI表单组件
- 图片与文件管理：支持本地上传与AI配图建议

#### 2.2 页面与模块划分
1. 首页/故事库总览
   - 故事列表（表格/卡片视图）、筛选、批量操作、新建入口
2. 新建/编辑故事（结构化编辑器）
   - 左侧结构树（分页/分段）、主编辑区（中英文、配图、风格）、右侧风格推荐、底部AI交互历史
3. 风格推荐与应用
   - 风格弹窗/侧栏，支持筛选、预览、应用
4. 经典改编流程
   - 经典故事选择、年龄段选择、自动分段生成、手动微调
5. AI辅助与交互历史
   - AI生成参数设置、历史记录、回滚/恢复、用户反馈
6. 导出与作品管理
   - 多格式导出、批量管理、历史版本

#### 2.3 交互流程
- 支持从故事库一键新建，进入结构化编辑器
- 编辑器内可随时切换风格、调用AI生成、手动编辑
- 经典改编入口独立，自动生成结构化内容
- 所有操作均有历史记录，支持回滚与对比
- 支持导出、批量管理、团队协作

#### 2.4 数据与API对接
- 前端通过RESTful API与后端交互，所有风格、故事、AI生成均结构化存储
- 风格模板直接读取`ai_picturebook_styles.json`
- 支持AI一键生成、补全、润色、经典改编等API

#### 2.5 迭代建议
- 第一阶段：实现故事库、结构化编辑器、风格推荐、基本AI生成
- 第二阶段：完善经典改编、AI交互历史、批量导出、团队协作
- 第三阶段：集成AI配图/音乐、移动端适配、个性化定制

---

> 2024-06-XX：已完成UI原型图片详细解读（见text/UI原型参考/UI原型图片详细解读.md），并制定详细UI开发方案。下一步将按方案分阶段推进开发，所有进展与决策将持续同步于本文件。

---

> 每完成一个阶段任务，将在此日志同步更新进度。

---

> 2024-06-XX：已将首页故事库开发方案与风险分析详细内容保存于 ai-collab/首页故事库开发方案与风险分析.md，包含组件结构、集成方式、mock与API切换、批量操作、UI一致性、扩展性、联调等内容。要点摘要如下：
- 组件结构：StoryLibraryPage为主，复用/扩展StoryList、CategoryManager、StoryUpload等，统计区可新建StatisticBar。
- 功能点：卡片展示、筛选、批量操作、单条操作、新建、导入、统计、分类管理、分页。
- 风险与应对：涵盖组件复用、mock与API切换、批量操作、UI一致性、扩展性、联调等，均有具体措施。

详细内容请查阅 ai-collab/首页故事库开发方案与风险分析.md。

---

## 2024-05-28 下一步重点开发工作

### 结构化绘本创作编辑器开发（第一阶段）

- 实现新建/编辑故事结构化编辑器页面，支持分段/分页结构、风格推荐、AI辅助生成、操作日志等。
- 主要功能包括：左侧结构树、主编辑区（中英文、配图、风格）、右侧风格推荐、顶部操作栏、底部AI交互历史。
- 前端先用mock数据驱动，后续无缝切换API。
- 设计并实现结构化故事相关API，支持增删改查、风格获取、AI辅助等。
- UI与交互严格参考《text/UI原型参考/》原型图片和解读文档，保证一致性和可扩展性。

### 结构化绘本创作编辑器开发推进方案

#### 一、核心目标
- 实现"新建/编辑故事"结构化编辑器页面，支持分段/分页、风格推荐、AI辅助生成、操作日志等。
- 前端先用mock数据驱动，后续无缝切换API。
- UI与交互严格参考《text/UI原型参考/》原型图片和解读文档，保证一致性和可扩展性。

#### 二、分阶段开发任务

**阶段1：基础框架与UI搭建**
1. 页面入口与路由：在首页"新建故事"按钮点击后，跳转到结构化编辑器页面（可用state或组件切换实现）。
2. 左侧结构树：展示故事结构（标题、分页/分段），支持增删页、拖拽排序（初期可先实现增删页）。
3. 主编辑区：每页支持中英文对照、旁白、配图建议、风格选择。提供基础表单输入，布局美观。
4. 顶部操作栏：包含返回、保存、导出、AI辅助、经典改编等按钮（初期可先实现返回、保存）。
5. 右侧风格推荐：展示风格名、说明、示例，支持一键应用（mock数据）。
6. 底部操作日志/AI交互历史：展示操作历史、AI生成记录（初期可用静态mock数据）。

**阶段2：功能完善与mock数据驱动**
1. 结构树与主编辑区联动：切换结构树节点，主编辑区内容同步切换。
2. 风格推荐与应用：右侧风格推荐区可一键应用风格到当前页。风格数据从ai_picturebook_styles.json mock读取。
3. AI辅助生成：提供"AI一键生成/润色"按钮，调用mock接口返回生成内容。
4. 保存与导出：支持将编辑内容保存到本地（可用JSON导出）。
5. 经典改编入口：预留经典改编流程入口，后续可集成。

**阶段3：API联调与高级功能**
1. 与后端API对接：故事结构化内容的增删改查、风格获取、AI辅助等API联调。
2. 操作日志与AI交互历史完善：记录所有编辑、AI生成、风格应用等操作，支持回滚。
3. UI美化与响应式优化：细化交互细节，提升用户体验。
4. 批量管理、团队协作等扩展功能预研。

#### 三、建议的目录与组件结构
frontend/src/components/
  ├── StoryEditorPage.jsx         // 结构化编辑器主页面
  ├── StoryStructureTree.jsx      // 左侧结构树
  ├── StoryPageEditor.jsx         // 主编辑区（单页编辑）
  ├── StyleRecommendation.jsx     // 右侧风格推荐
  ├── EditorToolbar.jsx           // 顶部操作栏
  ├── EditorHistoryLog.jsx        // 底部操作日志/AI交互历史
  └── ...（可按需细化）

#### 四、自动推进建议
- 优先实现StoryEditorPage及其子组件的基础UI和mock数据流转，确保页面可用、结构清晰。
- 每完成一个阶段，及时同步进展到AI对话上下文和开发日志，便于团队协作和后续AI辅助。
- 如需UI原型、mock数据、API接口示例、组件代码样板等，可随时让AI自动生成。

--- 