# 第一阶段开发总结 - 儿童绘本故事收集系统

本次会话聚焦于儿童绘本故事收集系统第一阶段的开发与完善。主要工作包括：

1.  **项目服务启动与脚本优化：**
    *   问题：服务器停止，需要重新运行前后端服务。
    *   解决方案：创建了 `start_services.ps1` PowerShell 脚本来启动后端 (`python app.py`) 和前端 (`npm start`，最初是 `npm run dev` 但发现脚本名为 `start` 后进行了修正)，解决了脚本执行时的目录切换问题。

2.  **前端界面功能与用户体验优化：**
    *   问题 1：系统主功能文案错误，显示"生成故事"。
    *   解决方案：修改前端代码 (`StoryCollector.js`) 将相关文案改为"收集故事"。
    *   问题 2：故事收集过程缺乏进度显示。
    *   解决方案：修改前端 (`StoryCollector.js`) 增加了收集中的按钮状态和可展开/收起的日志区域，显示 API 请求/响应过程。
    *   问题 3：刷新页面后 API Key 和模型设置丢失。
    *   解决方案：修改前端 (`Settings.js`, `StoryCollector.js`) 使用 `localStorage` 持久化保存 API Key、模型及其他设置，并在组件加载时读取。修正了设置加载的触发时机。

3.  **后端 API 集成与故事收集逻辑优化：**
    *   问题 1：AI 返回内容不是有效的 JSON 数组，导致后端解析失败，收集成功但保存0条。
    *   解决方案：增强后端 `/api/collect` 接口的 JSON 解析鲁棒性 (`backend/app.py`)，尝试从包含额外文本的响应内容中提取 JSON 数组。
    *   问题 2：收集到的故事字段不完整（如简介为"无"，创建时间为"Invalid Date"）。
    *   解决方案：修改后端 (`backend/app.py`)，确保向前端返回完整的入库故事对象，包含 `id` 和 `created_at` 等字段。
    *   问题 3：故事重复率高，多次尝试补足效果不佳，或收集数量不足。
    *   解决方案：优化后端 `/api/collect` 逻辑 (`backend/app.py`)，实现了：
        *   本地去重：在向 AI 请求前，将当前分类下数据库中已有的故事标题加入 Prompt。
        *   多次尝试补足：在一次 API 调用未能获得足够数量且不重复的故事时，进行多次调用直到达到目标数量或最大尝试次数。
        *   动态 Prompt：修改 `optimized_story_collect_prompt.md` 文件，并更新后端逻辑，动态地将需要收集的数量 `{N}` 和已有故事标题列表 `{titles}` 替换到 Prompt 中，明确要求 AI 避免返回已有故事。
    *   问题 4：API 调用返回 400 Bad Request，错误信息与 function call role 相关。
    *   解决方案：根据 SiliconFlow 文档，将发送给 API 的 function message 的 `role` 字段从 'function' 改为 'tool' (`backend/app.py`)。
    *   问题 5：AI 返回内容被截断，导致 JSON 不完整。
    *   解决方案：提高发送给 SiliconFlow API 的 `max_tokens` 参数值，从默认的 4096 增加到至少 8192 (`backend/app.py`)，以允许模型生成更长的响应。
    *   问题 6：后端报错"未指定故事分类"。
    *   解决方案：修正后端 `/api/collect` 逻辑 (`backend/app.py`)，使其优先从请求 JSON body 中的 `category` 字段获取分类，而不是从 Prompt 文本中解析。同时修改前端 (`StoryCollector.js`)，确保在发送请求时将选中的分类作为独立的 `category` 字段发送。
    *   问题 7：后端读取到的 Prompt 内容是旧版本。
    *   解决方案：排查文件结构，发现主仓库根目录和 `backend/` 目录下存在同名的 Prompt 文件。删除了 `backend/optimized_story_collect_prompt.md`，并修改后端逻辑将 Prompt 文件读取路径改为相对路径 `../optimized_story_collect_prompt.md`，确保读取项目根目录的 Prompt。

4.  **Git 仓库管理与远程同步：**
    *   问题 1：首次尝试 Git 推送失败（网络连接重置、连接超时）。
    *   解决方案：建议检查网络，并尝试使用 SSH 推送。
    *   问题 2：SSH 推送时遇到主机密钥验证失败。
    *   解决方案：指导用户手动在终端中确认主机密钥，将其添加到 `known_hosts` 文件。
    *   问题 3：SSH 推送时遇到 `Permission denied (publickey)` 错误。
    *   解决方案：指导用户生成 SSH 密钥对，并将公钥添加到 GitHub 账户设置。
    *   问题 4：项目包含主仓库和前端子模块两个独立的 Git 仓库，管理复杂，推送时遇到无关历史问题。
    *   解决方案：根据用户意愿，决定将整个工作区作为一个单一的 Git 仓库管理。执行了以下操作：
        *   将 `backend/stories.db` 添加到 `.gitignore`。
        *   删除了主仓库根目录下的 `.git` 文件夹（清除主仓库历史）。
        *   删除了 `frontend/` 目录下的 `.git` 文件夹（清除前端仓库历史）。
        *   在项目根目录初始化一个新的 Git 仓库。
        *   将工作区所有文件添加到新仓库并创建初次提交。
        *   指导用户在 GitHub 创建一个新的空远程仓库。
        *   将本地新仓库关联到新的远程仓库 (`git@github.com:leon30083/story-collector4.git`) 并成功推送了初次提交。
    *   问题 5：在尝试解决前端子模块的 Git 问题时，发现前端仓库的远程 URL 仍然是 HTTPS，并且删除远程分支失败。
    *   解决方案：在决定重建单一仓库之前，尝试将前端仓库远程 URL 改为 SSH 并强制推送，最终成功用本地前端仓库历史覆盖了远程。尽管最终选择了重建单一仓库，这个步骤也验证了 SSH 连接和强制推送在解决无关历史上的可能性。

**当前项目状态：**

*   项目代码（前后端）已整合到一个单一的 Git 仓库中。
*   该仓库已初始化并包含当前工作区的所有代码。
*   已成功推送到一个新的远程仓库 `git@github.com:leon30083/story-collector4.git`。
*   第一阶段的核心功能（故事收集、上传、列表、设置、去重、基础鲁棒性）已基本实现并修复了关键 Bug。 