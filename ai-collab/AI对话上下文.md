# AI对话上下文日志

## 项目简介
儿童绘本故事收集系统，旨在高效收集、整理、管理适合儿童绘本的故事题材，支持批量导入、AI采集、查重、分类、编辑、导出等。前端采用React+MUI，后端采用Flask+SQLAlchemy，数据库为SQLite，AI内容生成通过硅基流动API，结合动态Prompt模板。

---

## 当前开发阶段
- 主要目标/任务：
  - 支持故事采集、批量上传、查重、分类管理、故事展示与筛选、编辑与删除、导出、统计与可视化。
  - 采集逻辑强调"强制数量、去重、多样性"，支持长篇拆分、地方版本、细节变化。
- 近期已完成的关键进展：
  - 前后端项目结构与依赖配置
  - 故事CSV上传、查重、批量导入
  - 故事列表展示、筛选、搜索、详情弹窗
  - 故事编辑、删除、采集、API集成
  - 设置持久化、参数配置、界面优化
  - Prompt管理与AI协作日志机制完善
- 当前卡点/待解决问题：
  - 高级功能开发（分页、批量操作、导出、统计、UI美化、权限等）

---

## 重要决策与历史背景
- 目录结构、Prompt与AI协作日志已标准化，便于长期维护
- 查重、去重、API调用、Prompt路径等关键问题已优化解决
- 采集Prompt已高度优化，强调数量、去重、多样性、格式规范
- 采集与整理思路：长篇/合集类作品可拆分为多个独立故事，优先选择情节紧凑、角色鲜明、寓意积极的小故事或片段

---

## 需求与待办事项
- [ ] 支持分页与排序，提升大数据量下的浏览体验
- [ ] 故事导出功能（CSV/Excel）
- [ ] 故事批量删除、批量编辑
- [ ] 分类统计与可视化
- [ ] UI美化与响应式优化
- [ ] 用户权限与登录（如有需求）
- [ ] 采集表单支持更多自定义选项（如故事长度、风格等）
- [ ] 支持批量采集（如一次生成多条故事）
- [ ] 采集历史可追溯，支持重试、编辑采集结果
- [ ] 采集结果可直接导出或分享
- [ ] 故事内容敏感词过滤或审核提示
- [ ] 用户可对采集结果进行评分或反馈

---

## AI协作建议
- 希望AI协助代码实现、架构建议、Bug排查、文档撰写、测试用例设计、Prompt优化等
- 需注意历史决策、风格、兼容性、日志同步等
- 重要进展、决策、问题建议及时补充到本文件，保持团队与AI协作上下文同步

---

## 系统架构与代码地图
- 前端：React + MUI，负责交互、数据展示、采集请求、日志与进度反馈
- 后端：Flask + SQLAlchemy，API服务、AI采集、数据库管理、查重、分类管理
- 数据库：SQLite，存储故事与分类
- AI内容生成：硅基流动API，结合动态Prompt模板，自动采集和生成故事

### 主要功能模块
- 故事采集（AI+人工）、批量上传、查重、分类管理、故事展示与筛选、编辑与删除、导出、统计与可视化
- 支持多模型、多参数、采集日志、进度提示、错误反馈

### 目录结构
详见《系统架构与代码地图.md》

---

## 采集与整理思路
- 长篇/合集类作品（如《西游记》《格林童话集》）可拆分为多个独立故事
- 每个故事需情节完整、适合8-12页绘本、语言简洁、积极向上
- 优先选择情节紧凑、角色鲜明、寓意积极的小故事或片段
- 分类管理细致，便于检索和后续使用

---

## 采集Prompt模板（核心指令摘要）
- 强制采集指定数量（N）个指定分类（category）的故事，必须去重，优先补足数量
- 仅排除与数据库已有故事"标题完全相同"或"核心情节完全一致"的故事
- 返回格式为JSON数组，每个故事包含title、category、summary（含出处）
- summary内容简洁明了，适合表格展示
- 只输出JSON数组，不输出任何解释或多余内容
- 鼓励采集同一神话/人物/事件的不同版本、地方讲法、细节变化
- 详见《optimized_story_collect_prompt.md》

---

## 测试用例与质量保障
- 功能测试：采集、查重、上传、编辑、删除、导出、批量操作、进度日志、历史追溯等
- 参数与模型测试：AI模型切换、参数调整、API Key配置等
- 查重与一致性：重复检测、数据库与前端一致性
- 交互与体验：进度提示、错误反馈、表单校验、详情查看
- 边界与异常：超长输入、空内容、重复提交、接口超时、API限流等
- 扩展性与安全：自定义选项、批量采集、内容安全、用户反馈
- 详见《收集功能测试用例清单.md》

---

## 重要对话片段（AI历史问答精华）
- 2024-06-08：
  - 梳理并优化了AI协作上下文日志和Prompt的管理方式，所有AI协作相关文件（AI对话上下文.md、AI协作工作流使用说明.md、Prompt模板）已统一迁移至ai-collab/目录，并在prompts子目录下集中管理Prompt。
  - Prompt内容已升级，路径全部指向ai-collab/AI对话上下文.md，确保AI每次新会话都能准确加载上下文。
  - 明确了AI协作工作流的维护方法，包括日志维护、会话启动、对话片段整理、AI主动同步建议等。
  - 通过Cursor规则和Prompt，确保AI能主动提醒用户同步更新已解决的历史问题，保持日志与实际进度一致。
  - 目录结构和文件命名已标准化，便于长期维护和团队协作。
- 2024-06-13：
  - 讨论了将AI辅助绘本文稿创作集成到系统的优先级，决定优先实现结构化创作编辑器，后续再集成AI绘图和AI音乐模块。
  - 分析了现有gpts-prompt、ai_picturebook_styles.json、经典改编.md等知识库文件，确认已具备高质量AI文本创作能力和风格推荐机制。
  - 明确下一步以"结构化、可视化、可交互的绘本文稿创作平台"为目标，建议实现分段/分页编辑、风格模板一键应用、经典改编流程集成、AI辅助与手动编辑结合、作品管理与导出、为后续插图/音乐生成预留接口。
  - 推荐前端采用富文本/结构化编辑器，后端扩展API支持作品结构化存储与AI接口调用。
  - 建议优先梳理创作编辑器页面结构、数据结构、前端AI集成方式、作品管理与导出功能。
  - 明确如需UI原型、数据结构、API设计等具体方案，可随时让AI协助细化。

---

## 其他备注
- 任何你觉得AI需要知道的内容。

# 开发日志

## 项目名称：儿童绘本故事收集系统

### 2025-05-24

#### 1. 项目初始化
- [x] 初始化前端（React）与后端（Flask）项目结构
- [x] 配置本地开发环境，完成依赖安装
- [x] 初始化Git仓库并推送到GitHub

#### 2. 基础功能开发
- [x] 实现CSV文件上传功能，支持故事批量导入
- [x] 实现故事列表展示，支持按分类筛选
- [x] 前后端数据流转打通，上传后自动刷新列表

### 2025-05-25

#### 3. API集成与内容生成
- [x] 前端：增加"采集/生成故事"入口，支持API Key和偏好设置
- [x] 后端：完善`/api/collect`接口，调用硅基流动API，保存新故事
- [x] 设置组件优化：
  - 添加模型选择功能
  - 添加AI参数设置（温度、最大令牌数、Top P）
  - 实现设置持久化存储
  - 优化界面布局

#### 4. 数据导入与查重
- [x] 后端：上传时查重逻辑，防止重复故事入库
- [x] 前端：上传结果提示查重情况
- [x] 支持中文表头自动映射，兼容常见Excel导出格式

#### 5. 故事管理与展示
- [x] 故事列表重构为表格/列表模式，支持分类筛选、关键词搜索、简介预览、详情弹窗
- [x] 修复简介字段显示问题
- [x] 支持故事编辑、删除操作，含弹窗与全局提示

#### 6. 故事收集功能优化
- [x] 实现基于API的故事收集功能，支持指定数量和分类
- [x] 后端动态构建Prompt，将已有故事标题告知大模型用于去重
- [x] 后端实现本地查重和多次尝试补足逻辑
- [x] 前端增加采集进度显示和日志区域
- [x] 修复API调用400 Bad Request问题（Function call role更正）
- [x] 修复Prompt文件读取路径问题
- [x] 修复同名Prompt文件冲突问题
- [x] 优化Prompt指令，明确去重和分类要求
- [x] 修复AI返回内容不完整导致JSON解析失败的问题（提高API max_tokens限制）

---

## 下一阶段开发计划

#### 7. 高级功能与体验优化
- [ ] 支持分页与排序，提升大数据量下的浏览体验
- [ ] 故事导出功能（CSV/Excel）
- [ ] 故事批量删除、批量编辑
- [ ] 分类统计与可视化
- [ ] UI美化与响应式优化
- [ ] 用户权限与登录（如有需求）

---

## 接口文档与代码定位

### 后端API主文件
- 位置：`backend/app.py`
- 技术栈：Flask + SQLAlchemy

### 主要API接口一览

| 路径 | 方法 | 功能说明 |
|------|------|----------|
| /api/upload | POST | 上传CSV文件，批量导入故事，自动查重、分类 |
| /api/stories | GET | 获取故事列表，支持按分类和批次筛选 |
| /api/collect | POST | 采集AI故事，动态构建Prompt，去重、补足数量 |
| /api/settings | POST | 更新API Key等设置 |
| /api/models | POST | 获取可用AI模型列表 |
| /api/story/<id> | PUT | 编辑单个故事 |
| /api/story/<id> | DELETE | 删除单个故事 |
| /api/categories | GET | 获取所有分类 |
| /api/categories | POST | 新增分类 |
| /api/categories/<id> | PUT | 编辑分类（含同步故事表） |
| /api/categories/<id> | DELETE | 删除分类及其下所有故事 |
| /api/stories/batch_delete | POST | 批量删除故事 |
| /api/stories/batch_update_category | POST | 批量修改故事分类 |
| /api/stories/batch_export | POST | 批量导出故事（CSV） |
| /api/stories/export_by_batch | GET | 按批次导出故事（CSV） |

> 详细参数、字段、示例可参考 `backend/app.py` 代码实现。如需自动生成详细接口文档，可进一步提取和补充。

---

> 每完成一个阶段任务，将在此日志同步更新进度。 