# 整合后全模块详细实现方案（2025-05-29）

---

## 目录
1. 项目管理模块
2. 基础信息与风格模板模块
3. 脚本生成与管理模块
4. 分镜与提示词模块
5. 图像生成与任务队列模块
6. ComfyUI后处理模块
7. 资产导出模块
8. 系统设置与API管理模块
9. 数据迁移脚本样例
10. 测试用例模板
11. 数据库位置与规范

---

## 1. 项目管理模块
### 1.1 主要功能
- 项目（故事/绘本）增删改查、切换、进度统计
- 支持批量操作、项目搜索

### 1.2 主要接口
- `GET /api/projects` 获取项目列表
- `POST /api/projects` 新建项目
- `PATCH /api/projects/{id}` 重命名项目
- `DELETE /api/projects/{id}` 删除项目
- `GET /api/projects/{id}` 获取单个项目详情

#### 示例：获取项目列表
```
GET /api/projects
返回：
[
  {
    "id": "1",
    "title": "童话森林探险",
    "progress": 0.7,
    "scene_count": 8,
    "last_edit": "2025-05-28T10:00:00"
  }, ...
]
```

---

## 2. 基础信息与风格模板模块
### 2.1 主要功能
- 保存/读取项目基础信息（主题、适龄段、风格、关键词）
- 获取风格模板列表和详情

### 2.2 主要接口
- `POST /api/projects/{id}/meta` 保存基础信息
- `GET /api/styles` 获取风格模板列表
- `GET /api/styles/{id}` 获取风格详情

#### 示例：获取风格模板
```
GET /api/styles
返回：
[
  {"id": "warm", "name": "温暖童话", "desc": "温馨治愈...", "image": "url"}, ...
]
```

---

## 3. 脚本生成与管理模块
### 3.1 主要功能
- AI脚本生成、脚本保存、历史版本、导入/导出

### 3.2 主要接口
- `POST /api/script/generate` AI生成脚本
- `POST /api/projects/{id}/script` 保存脚本
- `GET /api/projects/{id}/script/history` 获取历史版本
- `POST /api/projects/{id}/script/import` 导入脚本
- `GET /api/projects/{id}/script/export` 导出脚本

#### 示例：AI生成脚本
```
POST /api/script/generate
body: {"theme": "草船借箭", "age_range": "5-8岁", "style_id": "warm"}
返回：{"script_cn": "...", "script_en": "...", "segments": [...]}
```

---

## 4. 分镜与提示词模块
### 4.1 主要功能
- 分镜提示词生成、编辑、批量操作、导出

### 4.2 主要接口
- `POST /api/prompt/generate` AI生成分镜提示词
- `POST /api/projects/{id}/prompts` 保存分镜提示词
- `GET /api/projects/{id}/prompts/export` 导出分镜提示词

#### 示例：AI生成分镜提示词
```
POST /api/prompt/generate
body: {"script": "...", "style_id": "warm"}
返回：{"storyboards": ["清晨，森林...", ...]}
```

---

## 5. 图像生成与任务队列模块
### 5.1 主要功能
- 批量图片生成、进度监控、重试、下载、日志

### 5.2 主要接口
- `POST /api/image/doubao/batch` 批量生成图片
- `GET /api/image/tasks` 获取任务进度与状态
- `POST /api/image/tasks/{id}/retry` 重试任务
- `GET /api/image/tasks/{id}/download` 下载图片
- `GET /api/image/tasks/{id}/log` 获取任务日志

#### 示例：获取任务进度
```
GET /api/image/tasks
返回：
[
  {"id": "t1", "status": "processing", "progress": 60, "result_url": null}, ...
]
```

---

## 6. ComfyUI后处理模块
### 6.1 主要功能
- 图片本地后处理，节点化工作流

### 6.2 主要接口
- `POST /api/image/comfyui/process` ComfyUI后处理

#### 示例：
```
POST /api/image/comfyui/process
body: {"image_id": "t1", "workflow": {...}}
返回：{"status": "success", "result_url": "..."}
```

---

## 7. 资产导出模块
### 7.1 主要功能
- 导出PDF/EPUB/ZIP/PPTX，进度、下载

### 7.2 主要接口
- `POST /api/export` 发起导出任务
- `GET /api/export/{id}/progress` 查询导出进度
- `GET /api/export/{id}/download` 下载导出文件

#### 示例：发起导出
```
POST /api/export
body: {"project_id": "1", "type": "PDF", "range": "all"}
返回：{"export_id": "e1", "status": "pending"}
```

---

## 8. 系统设置与API管理模块
### 8.1 主要功能
- API Key、模型参数等配置的保存与读取

### 8.2 主要接口
- `GET /api/settings` 获取API配置
- `POST /api/settings` 保存API配置
- `POST /api/settings/test` 测试API连通性

#### 示例：保存API配置
```
POST /api/settings
body: {"siliconflow_key": "...", "model": "sf-chat-2.0"}
返回：{"status": "success"}
```

---

## 9. 数据迁移脚本样例
```python
# 假设旧数据为stories_old.json，目标为stories_new.json
import json
with open('stories_old.json', 'r', encoding='utf-8') as f:
    old_data = json.load(f)
new_data = []
for story in old_data:
    new_story = {
        "id": story["id"],
        "title": story["title"],
        "author": story.get("author", ""),
        "age_range": story.get("age_range", ""),
        "theme": story.get("theme", ""),
        "style_id": story.get("style_id", ""),
        "category_id": story.get("category_id", ""),
        "summary": story.get("summary", ""),
        "created_at": story.get("created_at", ""),
        "updated_at": story.get("updated_at", ""),
        "classic_adapted": story.get("classic_adapted", False),
        "classic_source": story.get("classic_source", ""),
        "batch_id": story.get("batch_id", ""),
        "status": story.get("status", "draft"),
        "pages": [{
            "page_no": 1,
            "text_cn": story.get("content", ""),
            "text_en": story.get("content_en", ""),
            "image_hint": "",
            "template_used": story.get("style_id", "")
        }]
    }
    new_data.append(new_story)
with open('stories_new.json', 'w', encoding='utf-8') as f:
    json.dump(new_data, f, ensure_ascii=False, indent=2)
```

---

## 10. 测试用例模板
### 10.1 故事管理模块
- [ ] 新建故事，检查数据库是否新增
- [ ] 编辑故事，检查内容是否更新
- [ ] 删除故事，检查是否移除
- [ ] 批量导出，检查导出文件内容

### 10.2 AI采集与生成
- [ ] 采集指定数量故事，检查数量与去重
- [ ] AI生成脚本，检查内容完整性
- [ ] AI生成分镜提示词，检查格式与内容

### 10.3 图片生成与导出
- [ ] 批量生成图片，检查任务进度与结果
- [ ] 图片重试、下载、日志功能
- [ ] 资产导出，检查导出文件类型与内容

### 10.4 设置与API
- [ ] API Key保存与读取
- [ ] API连通性测试

---

## 11. 数据库位置与规范

- **唯一数据库文件位置**：`data/stories.db`
- 所有后端API、脚本、数据迁移、批量处理等，均须统一指向 `data/stories.db`。
- 项目根目录和 backend/ 目录下的 stories.db 已废弃并自动清理。
- 后续如有新脚本或API涉及数据库操作，也请务必统一指向 `data/stories.db`，避免数据分散和混乱。

如需某一模块的详细代码实现、接口参数说明、前端对接示例，请随时补充！ 