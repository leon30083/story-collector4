好的，以下是**整合后“儿童绘本故事收集与结构化创作平台”技术指导书**，涵盖架构、数据结构、API、开发规范、迁移、联调、测试、协作等，适用于后续开发全流程。

---

# 儿童绘本故事收集与结构化创作平台 技术指导书

## 一、项目目标与整体架构

### 1.1 项目目标
- 实现“故事收集、批量管理、AI采集、查重、分类、编辑、导出”与“结构化分段/分页创作、风格推荐、AI辅助、经典改编”等功能一体化。
- 支持本地运行，低复杂度，易维护，便于后续扩展。

### 1.2 技术栈
- 前端：React + MUI（Material UI）/Tailwind，静态页面或SPA
- 后端：Python + Flask + SQLAlchemy
- 数据库：SQLite（本地文件型数据库）
- AI能力：硅基流动API（或本地AI服务），Prompt模板可配置
- 文件/图片/导出：本地文件系统

### 1.3 系统架构图

```
┌──────────────┐         HTTP/REST         ┌──────────────┐
│   前端 React  │  <-------------------->  │   Flask后端   │
└──────────────┘                           └──────────────┘
         │                                         │
         ▼                                         ▼
   用户浏览器                           SQLite数据库（stories.db）
```

---

## 二、核心数据结构设计

### 2.1 Story（故事/绘本）

| 字段名         | 类型         | 说明                         |
|----------------|--------------|------------------------------|
| id             | int/str      | 主键，自增或UUID             |
| title          | str          | 故事标题                     |
| author         | str          | 作者/采集来源                |
| age_range      | str          | 适龄段（如“3-5岁”）          |
| theme          | str          | 主题                         |
| style_id       | str/int      | 风格模板ID                   |
| category_id    | str/int      | 分类ID                       |
| summary        | str          | 简介/摘要                    |
| created_at     | datetime     | 创建时间                     |
| updated_at     | datetime     | 更新时间                     |
| classic_adapted| bool         | 是否经典改编                 |
| classic_source | str          | 改编自哪个经典               |
| batch_id       | str          | 批次号（采集/上传/导出）     |
| status         | str          | 状态（草稿/已发布/已导出等） |
| pages          | JSON/array   | 结构化分页内容（见下）       |

#### pages字段结构
```json
[
  {
    "page_no": 1,
    "text_cn": "中文内容",
    "text_en": "English content",
    "image_hint": "配图建议",
    "template_used": "风格模板名"
  }
]
```

### 2.2 Category（分类）

| 字段名     | 类型     | 说明         |
|------------|----------|--------------|
| id         | int/str  | 主键         |
| name       | str      | 分类名称     |
| parent_id  | int/str  | 父级分类ID   |

### 2.3 Style（风格模板）

| 字段名     | 类型     | 说明         |
|------------|----------|--------------|
| id         | int/str  | 主键         |
| name       | str      | 风格名称     |
| desc       | str      | 风格描述     |
| image      | str      | 示例图片URL  |

### 2.4 Prompt（提示词/采集模板）

| 字段名     | 类型     | 说明         |
|------------|----------|--------------|
| id         | int/str  | 主键         |
| type       | str      | 类型（文稿/分镜）|
| name       | str      | 名称/版本    |
| content    | str      | 提示词内容   |

### 2.5 ImageTask（图片生成/后处理任务）

| 字段名     | 类型     | 说明         |
|------------|----------|--------------|
| id         | int/str  | 主键         |
| story_id   | int/str  | 关联故事ID   |
| page_no    | int      | 关联页码     |
| status     | str      | 状态         |
| result_url | str      | 图片URL      |
| log        | str      | 任务日志     |
| created_at | datetime | 创建时间     |

### 2.6 ExportTask（导出任务）

| 字段名     | 类型     | 说明         |
|------------|----------|--------------|
| id         | int/str  | 主键         |
| story_ids  | array    | 导出故事ID列表|
| type       | str      | 导出类型     |
| status     | str      | 状态         |
| file_url   | str      | 导出文件URL  |
| progress   | int      | 进度百分比   |
| created_at | datetime | 创建时间     |

---

## 三、API接口设计（RESTful）

### 3.1 故事管理

- `GET /api/stories`  
  获取故事列表，支持分页、筛选、关键词、分类、批次等参数

- `POST /api/stories`  
  新建故事（支持结构化内容）

- `GET /api/stories/<id>`  
  获取单个故事详情

- `PUT /api/stories/<id>`  
  编辑故事（支持结构化内容）

- `DELETE /api/stories/<id>`  
  删除故事

- `POST /api/stories/batch_delete`  
  批量删除故事

- `POST /api/stories/batch_export`  
  批量导出故事（CSV/Excel/PDF/EPUB/ZIP/PPTX）

### 3.2 分类管理

- `GET /api/categories`  
  获取所有分类

- `POST /api/categories`  
  新增分类

- `PUT /api/categories/<id>`  
  编辑分类

- `DELETE /api/categories/<id>`  
  删除分类

### 3.3 风格模板

- `GET /api/styles`  
  获取风格模板列表

- `GET /api/styles/<id>`  
  获取风格模板详情

### 3.4 AI采集与生成

- `POST /api/collect`  
  采集AI故事，参数：主题、分类、数量、风格、采集Prompt等

- `POST /api/script/generate`  
  AI生成结构化脚本/分段内容

- `POST /api/prompt/generate`  
  AI生成分镜提示词

### 3.5 提示词管理

- `GET /api/prompts`  
  获取提示词库

- `POST /api/prompts`  
  新增/保存提示词

- `PATCH /api/prompts/<id>`  
  修改提示词

- `DELETE /api/prompts/<id>`  
  删除提示词

### 3.6 图片生成与后处理

- `POST /api/image/doubao/batch`  
  批量生成图片

- `GET /api/image/tasks`  
  获取图片任务进度与状态

- `POST /api/image/tasks/<id>/retry`  
  重试图片任务

- `GET /api/image/tasks/<id>/download`  
  下载图片

- `GET /api/image/tasks/<id>/log`  
  获取任务日志

- `POST /api/image/comfyui/process`  
  ComfyUI后处理

### 3.7 资产导出

- `POST /api/export`  
  发起导出任务

- `GET /api/export/<id>/progress`  
  查询导出进度

- `GET /api/export/<id>/download`  
  下载导出文件

### 3.8 系统设置

- `GET /api/settings`  
  获取API Key、模型参数等配置

- `POST /api/settings`  
  保存API Key、模型参数等配置

- `POST /api/settings/test`  
  测试API连通性

---

## 四、开发规范与建议

### 4.1 代码结构建议

- 后端每个功能模块单独一个py文件（如story.py、category.py、ai.py、image.py、export.py、settings.py），主入口app.py统一注册路由。
- 前端每个页面/功能区块单独组件，复用表单、弹窗、列表等UI组件。
- 数据库迁移、备份脚本单独管理，便于升级和回滚。

### 4.2 迁移步骤

1. **数据结构统一**  
   - 对比旧系统和新系统的Story、Category、Style等表结构，合并字段，补充结构化分页内容。
   - 编写数据迁移脚本，将旧数据导入新表结构（如将原有故事内容转为pages[0].text_cn）。

2. **API接口合并**  
   - 保留原有采集、查重、分类、导出等API，新增结构化编辑、风格推荐、AI辅助创作等接口。
   - 统一接口风格和参数命名，保证前端无缝切换。

3. **前端页面融合**  
   - 首页/仪表盘可切换“故事收集管理”与“结构化创作平台”。
   - 共用故事库、分类、导出等功能，结构化编辑器与采集管理互通。

4. **测试与验证**  
   - 用原有测试用例+新功能测试用例，全面验证数据一致性、功能完整性、接口兼容性。

5. **文档与协作机制同步**  
   - 更新AI协作日志、开发日志、接口文档，确保团队和AI助手都能跟进最新架构。

---

## 五、前后端联调方案

1. **接口Mock与联调**  
   - 后端先实现接口Mock，前端用mock数据开发，接口稳定后切换真实API。
   - 每个接口提供字段示例和返回格式，便于前端调试。

2. **接口文档同步**  
   - 推荐用Swagger/OpenAPI或Markdown文档，详细列出每个接口的参数、返回、示例。

3. **联调流程**  
   - 前端开发完成单页/组件后，逐步对接后端API，发现问题及时同步修正。
   - 复杂流程（如采集、批量导出、结构化编辑）可用Postman等工具先行测试。

4. **日志与错误追踪**  
   - 前后端均需详细日志，便于排查问题。
   - 关键操作（采集、导出、AI生成等）需有进度与错误反馈。

5. **协作与回溯**  
   - 重要决策、接口变更、Bug修复等同步到AI对话上下文和开发日志，便于团队和AI助手长期协作。

---

## 六、测试与质量保障

- 参考《收集功能测试用例清单.md》，补充结构化创作相关测试用例。
- 功能测试、参数与模型测试、查重与一致性、交互与体验、边界与异常、扩展性与安全等全覆盖。
- 自动化测试建议：后端接口单元测试、前端组件测试、集成测试。

---

## 七、协作与文档管理

- 继续沿用AI协作日志、开发日志、接口文档、测试用例等机制，便于团队和AI长期协作。
- 重要决策、接口变更、Bug修复等同步到AI对话上下文和开发日志，便于追溯和维护。
- 所有文档、代码、数据、测试用例、日志等统一归档，便于长期维护。

---

如需**具体某一模块的详细实现方案、接口参数示例、迁移脚本样例、测试用例模板**，请随时告知！  
本技术指导书可作为后续开发、联调、维护、扩展的权威参考。
